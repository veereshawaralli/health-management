<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Health Manager</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#22c55e;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
      --danger:#ef4444;
      --soft:#111827;
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,#071022 0%, #071826 60%);
      color:#e6eef6; -webkit-font-smoothing:antialiased;
      display:flex;justify-content:center;padding:24px;
    }
    .wrap{
      width:100%;max-width:var(--maxw);display:grid;grid-template-columns:280px 1fr;gap:20px;
    }
    header.app{
      grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      border:1px solid rgba(255,255,255,0.03);
      margin-bottom:6px;
    }
    header.app h1{font-size:18px;margin:0}
    .sidebar{
      background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);height:calc(100vh - 120px);overflow:auto;
      position:sticky;top:24px;
    }
    .profile-mini{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .avatar{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#04201a}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{background:transparent;border:none;color:var(--muted);text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-weight:600}
    .nav button.active{background:rgba(255,255,255,0.03);color:#fff}
    .card{background:var(--glass);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    main{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-height:70vh}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .row{display:flex;gap:12px}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input,select,textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;
      outline:none;font-size:14px;
    }
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#032014;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .stats{display:flex;gap:12px}
    .stat{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:12px;border-radius:10px}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:14px}
    .danger{color:var(--danger)}
    canvas{width:100%;height:160px;background:transparent;border-radius:8px}
    .footer-note{font-size:12px;color:var(--muted);margin-top:12px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600;font-size:12px}
    @media(max-width:900px){
      .wrap{grid-template-columns:1fr; padding:12px}
      .sidebar{position:relative;height:auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="app">
      <h1>Health Manager</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted small">Local-only • data saved in browser</div>
        <button id="exportBtn" class="btn ghost">Export</button>
        <button id="importBtn" class="btn ghost">Import</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none"/>
      </div>
    </header>

    <aside class="sidebar card">
      <div class="profile-mini">
        <div class="avatar" id="avatarText">U</div>
        <div>
          <div id="miniName" style="font-weight:700">User</div>
          <div class="muted small" id="miniGoals">No goals set</div>
        </div>
      </div>

      <div class="nav" role="navigation" aria-label="Main">
        <button data-tab="dashboard" class="active">Dashboard</button>
        <button data-tab="profile">Profile</button>
        <button data-tab="meals">Meals & Calories</button>
        <button data-tab="exercise">Exercise Log</button>
        <button data-tab="progress">Progress</button>
        <button data-tab="settings">Settings</button>
      </div>

      <div style="margin-top:16px">
        <div class="small muted">Quick actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="quickAddMeal" class="btn ghost">+ Meal</button>
          <button id="quickAddExercise" class="btn ghost">+ Exercise</button>
        </div>
      </div>
    </aside>

    <main>
      <section id="dashboard" class="card tab">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div class="muted small">Welcome back,</div>
            <div style="font-weight:700;font-size:20px" id="dashName">User</div>
            <div class="muted small" id="dashGoal">Set a goal to get started</div>
          </div>
          <div style="text-align:right">
            <div class="pill" id="todayDate"></div>
            <div class="muted small" style="margin-top:6px" id="calSummary">Calories: 0 in • 0 out</div>
          </div>
        </div>

        <div class="grid cols-2" style="grid-template-rows:auto">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Daily Health</div>
              <div class="muted small">Track BMI, BMR & TDEE</div>
            </div>

            <div class="row" style="margin-bottom:10px">
              <div style="flex:1">
                <label>Weight (kg)</label>
                <input id="inputWeight" type="number" min="20" step="0.1"/>
              </div>
              <div style="flex:1">
                <label>Height (cm)</label>
                <input id="inputHeight" type="number" min="80" step="0.1"/>
              </div>
              <div style="flex:1">
                <label>Age</label>
                <input id="inputAge" type="number" min="10" step="1"/>
              </div>
              <div style="flex:1">
                <label>Gender</label>
                <select id="inputGender">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div style="display:flex;gap:8px;align-items:center">
              <button id="calcBtn" class="btn">Calculate</button>
              <button id="saveProfileBtn" class="btn ghost">Save Profile</button>
              <div style="margin-left:auto;text-align:right">
                <div style="font-weight:700" id="bmiVal">BMI —</div>
                <div class="muted small" id="bmiCat">—</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Calories & Plan</div>
              <div class="muted small">BMR & daily target</div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <div style="flex:1">
                <label>Activity</label>
                <select id="activity">
                  <option value="1.2">Sedentary</option>
                  <option value="1.375">Light</option>
                  <option value="1.55">Moderate</option>
                  <option value="1.725">Active</option>
                  <option value="1.9">Very active</option>
                </select>
              </div>
              <div style="flex:1">
                <label>Goal</label>
                <select id="goalSelect">
                  <option value="maintain">Maintain</option>
                  <option value="lose-0.25">Lose 0.25 kg/wk</option>
                  <option value="lose-0.5">Lose 0.5 kg/wk</option>
                  <option value="gain-0.25">Gain 0.25 kg/wk</option>
                </select>
              </div>
            </div>

            <div style="display:flex;gap:12px;align-items:center">
              <div style="flex:1">
                <div class="small muted">BMR</div>
                <div style="font-weight:700" id="bmrVal">— kcal</div>
              </div>
              <div style="flex:1">
                <div class="small muted">TDEE</div>
                <div style="font-weight:700" id="tdeeVal">— kcal</div>
              </div>
              <div style="flex:1">
                <div class="small muted">Daily Target</div>
                <div style="font-weight:700" id="targetVal">— kcal</div>
              </div>
            </div>
          </div>

          <div class="card" style="grid-column:1 / -1">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Today's Summary</div>
              <div class="muted small">Add meals & exercises</div>
            </div>

            <div style="display:flex;gap:12px;margin-bottom:12px">
              <div style="flex:1">
                <label>Meal name</label>
                <input id="mealName" placeholder="e.g., Breakfast: Oats" />
              </div>
              <div style="width:140px">
                <label>Calories</label>
                <input id="mealCals" type="number" min="0" />
              </div>
              <div style="width:120px;display:flex;flex-direction:column;justify-content:flex-end">
                <button id="addMealBtn" class="btn">Add Meal</button>
              </div>
            </div>

            <div style="display:flex;gap:12px">
              <div style="flex:1">
                <div style="font-weight:700">Meals</div>
                <div id="mealsList" style="margin-top:8px"></div>
              </div>
              <div style="width:260px">
                <div style="font-weight:700">Exercises</div>
                <div id="exList" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="profile" class="card tab" style="display:none">
        <div style="font-weight:700;margin-bottom:6px">Profile</div>
        <div class="muted small" style="margin-bottom:12px">Your info is saved locally in your browser.</div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>Full name</label>
            <input id="fullName" placeholder="Your name" />
            <label style="margin-top:8px">Target weight (kg)</label>
            <input id="targetWeight" type="number" min="20" step="0.1"/>
            <label style="margin-top:8px">Notes / Goals</label>
            <textarea id="notes" rows="4" placeholder="e.g., lose 5 kg in 3 months"></textarea>
            <div style="margin-top:10px">
              <button id="saveBtn" class="btn">Save</button>
              <button id="clearBtn" class="btn ghost">Clear</button>
            </div>
          </div>

          <div>
            <div style="font-weight:700;margin-bottom:8px">Quick stats</div>
            <div class="stats">
              <div class="stat">
                <div class="small muted">Current weight</div>
                <div id="statWeight">— kg</div>
              </div>
              <div class="stat">
                <div class="small muted">BMI</div>
                <div id="statBmi">—</div>
              </div>
              <div class="stat">
                <div class="small muted">Target</div>
                <div id="statTarget">—</div>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="small muted">Weight history</div>
              <canvas id="weightChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="meals" class="card tab" style="display:none">
        <div style="font-weight:700;margin-bottom:6px">Meals & Calories</div>
        <div class="muted small" style="margin-bottom:12px">Add common foods or quick log</div>

        <div style="display:flex;gap:12px;margin-bottom:12px">
          <input id="foodQuickName" placeholder="Food e.g., Banana" />
          <input id="foodQuickCals" type="number" placeholder="Calories" />
          <button id="addQuickFood" class="btn">Add</button>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div style="font-weight:700">All meals</div>
            <div id="allMealsContainer" style="margin-top:8px"></div>
          </div>

          <div style="width:260px">
            <div style="font-weight:700">Totals</div>
            <div style="margin-top:8px">
              <div class="small muted">Today</div>
              <div style="font-weight:700" id="totalToday">0 kcal</div>
              <div class="small muted" style="margin-top:6px">This week</div>
              <div style="font-weight:700" id="totalWeek">0 kcal</div>
            </div>
          </div>
        </div>
      </section>

      <section id="exercise" class="card tab" style="display:none">
        <div style="font-weight:700;margin-bottom:6px">Exercise Log</div>
        <div class="muted small" style="margin-bottom:12px">Log exercises and estimate calories burned</div>

        <div style="display:flex;gap:12px;margin-bottom:12px">
          <input id="exName" placeholder="Exercise e.g., Running" />
          <input id="exMin" type="number" min="1" placeholder="Minutes" />
          <input id="exCals" type="number" placeholder="Est. kcal" />
          <button id="addExBtn" class="btn">Add</button>
        </div>

        <div id="exerciseList"></div>
      </section>

      <section id="progress" class="card tab" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Progress</div>
          <div class="muted small">Visualize weight & calories</div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 300px;gap:12px">
          <div class="card">
            <canvas id="calChart"></canvas>
          </div>
          <div class="card">
            <div style="font-weight:700">Recent logs</div>
            <div id="recentLogs" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <section id="settings" class="card tab" style="display:none">
        <div style="font-weight:700;margin-bottom:6px">Settings</div>
        <div class="muted small" style="margin-bottom:12px">Data is stored locally. You can export/import JSON backup.</div>
        <div style="display:flex;gap:8px">
          <button id="resetBtn" class="btn ghost">Reset All Data</button>
        </div>
      </section>

      <div class="footer-note">Built for local testing. No data leaves your browser unless exported.</div>
    </main>
  </div>

  <script>
    // Simple SPA tabbing
    const tabs = document.querySelectorAll('.nav button');
    const sections = document.querySelectorAll('.tab');
    tabs.forEach(btn=>{
      btn.addEventListener('click', ()=> {
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const t = btn.dataset.tab;
        sections.forEach(s => s.style.display = s.id === t ? '' : 'none');
      });
    });

    // Utilities
    const $ = sel => document.querySelector(sel);
    const todayKey = () => {
      const d = new Date();
      return d.toISOString().slice(0,10);
    };

    // State from localStorage
    const storageKey = 'hm_data_v1';
    let state = {
      profile: {name:'User', age:30, weight:70, height:170, gender:'male', targetWeight:null, notes:''},
      meals: {}, // meals[date] = [{id,name,cals,ts}]
      exercises: {},
      weights: {}, // weights[date] = kg
      createdAt: new Date().toISOString()
    };

    function load() {
      try {
        const raw = localStorage.getItem(storageKey);
        if(raw) state = JSON.parse(raw);
      } catch(e){ console.error(e) }
    }
    function save() {
      localStorage.setItem(storageKey, JSON.stringify(state));
      renderAll();
    }

    // Init
    load();

    // DOM elements
    const inputWeight = $('#inputWeight');
    const inputHeight = $('#inputHeight');
    const inputAge = $('#inputAge');
    const inputGender = $('#inputGender');
    const calcBtn = $('#calcBtn');
    const bmrVal = $('#bmrVal');
    const tdeeVal = $('#tdeeVal');
    const targetVal = $('#targetVal');
    const bmiVal = $('#bmiVal'); const bmiCat = $('#bmiCat');
    const activity = $('#activity'); const goalSelect = $('#goalSelect');
    const saveProfileBtn = $('#saveProfileBtn');
    const fullName = $('#fullName'); const targetWeight = $('#targetWeight'); const notes = $('#notes'); const saveBtn = $('#saveBtn'); const clearBtn = $('#clearBtn');
    const mealName = $('#mealName'); const mealCals = $('#mealCals'); const addMealBtn = $('#addMealBtn'); const mealsList = $('#mealsList');
    const exName = $('#exName'); const exMin = $('#exMin'); const exCals = $('#exCals'); const addExBtn = $('#addExBtn'); const exList = $('#exList');
    const statWeight = $('#statWeight'); const statBmi = $('#statBmi'); const statTarget = $('#statTarget');
    const miniName = $('#miniName'); const miniGoals = $('#miniGoals'); const avatarText = $('#avatarText'); const dashName = $('#dashName'); const dashGoal = $('#dashGoal');
    const todayDate = $('#todayDate'); const calSummary = $('#calSummary'); const totalToday = $('#totalToday'); const totalWeek = $('#totalWeek');
    const allMealsContainer = $('#allMealsContainer'); const exerciseList = $('#exerciseList'); const recentLogs = $('#recentLogs');
    const quickAddMeal = $('#quickAddMeal'); const quickAddExercise = $('#quickAddExercise');
    const weightChart = document.getElementById('weightChart');
    const calChart = document.getElementById('calChart');
    const exportBtn = $('#exportBtn'); const importBtn = $('#importBtn'); const fileInput = $('#fileInput'); const resetBtn = $('#resetBtn'); const fileImport = $('#fileInput');

    // Helpers
    function uid(prefix='id') { return prefix+'_'+Math.random().toString(36).slice(2,9); }
    function formatDate(dStr) {
      const d = new Date(dStr); return d.toLocaleDateString();
    }

    function calcBMI(w, hCm) {
      if(!w||!hCm) return null;
      const h = hCm/100;
      const bmi = w / (h*h);
      return Math.round(bmi*10)/10;
    }
    function bmiCategory(bmi) {
      if(!bmi) return '';
      if(bmi < 18.5) return 'Underweight';
      if(bmi < 25) return 'Normal';
      if(bmi < 30) return 'Overweight';
      return 'Obese';
    }
    function calcBMR(sex, weight, heightCm, age) {
      // Mifflin-St Jeor
      if(!weight || !heightCm || !age) return null;
      if(sex === 'female') {
        return Math.round(10*weight + 6.25*heightCm - 5*age - 161);
      } else {
        return Math.round(10*weight + 6.25*heightCm - 5*age + 5);
      }
    }

    // Meals & exercises storage
    function addMeal(date, name, cals) {
      const id = uid('m');
      if(!state.meals[date]) state.meals[date] = [];
      state.meals[date].push({id,name,cals:Math.max(0,Math.round(cals||0)),ts:new Date().toISOString()});
      save();
    }
    function removeMeal(date,id) {
      if(!state.meals[date]) return;
      state.meals[date] = state.meals[date].filter(m=>m.id!==id);
      save();
    }
    function addExercise(date, name, mins, cals) {
      const id = uid('e');
      if(!state.exercises[date]) state.exercises[date] = [];
      state.exercises[date].push({id,name,mins:Math.max(0,Math.round(mins||0)),cals:Math.max(0,Math.round(cals||0)),ts:new Date().toISOString()});
      save();
    }
    function removeExercise(date,id) {
      if(!state.exercises[date]) return;
      state.exercises[date] = state.exercises[date].filter(e=>e.id!==id);
      save();
    }

    // Render functions
    function renderMini() {
      const p = state.profile;
      miniName.textContent = p.name || 'User';
      dashName.textContent = p.name || 'User';
      avatarText.textContent = (p.name||'U').trim().split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase();
      miniGoals.textContent = p.notes || 'No goals set';
      dashGoal.textContent = p.notes || 'No goals set';
      fullName.value = p.name || '';
      targetWeight.value = p.targetWeight || '';
      notes.value = p.notes || '';
    }

    function todaysMeals() {
      return state.meals[todayKey()] || [];
    }
    function todaysExercises() {
      return state.exercises[todayKey()] || [];
    }

    function renderMealsList() {
      const m = todaysMeals();
      mealsList.innerHTML = m.length ? '<table><thead><tr><th>Meal</th><th>kcal</th><th></th></tr></thead><tbody>' 
        + m.map(x=>`<tr><td>${escapeHtml(x.name)}</td><td>${x.cals}</td><td><button data-id="${x.id}" class="btn ghost small removeMeal">Remove</button></td></tr>`).join('') 
        + '</tbody></table>' : '<div class="muted small">No meals logged today</div>';
      // attach remove handlers
      mealsList.querySelectorAll('.removeMeal').forEach(b=>{
        b.addEventListener('click', ()=> removeMeal(todayKey(), b.dataset.id));
      });

      // All meals section
      const dates = Object.keys(state.meals).sort((a,b)=>b.localeCompare(a));
      allMealsContainer.innerHTML = dates.length ? dates.map(d=>{
        const items = state.meals[d] || [];
        const sum = items.reduce((s,i)=>s+i.cals,0);
        return `<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between"><div style="font-weight:700">${formatDate(d)}</div><div class="muted small">${sum} kcal</div></div>
          <div class="muted small">${items.map(it=>escapeHtml(it.name)+' — '+it.cals+' kcal').join('<br>')}</div></div>`;
      }).join('') : '<div class="muted small">No meals recorded</div>';
    }

    function renderExercises() {
      const items = todaysExercises();
      exList.innerHTML = items.length ? '<table><thead><tr><th>Exercise</th><th>mins</th><th>kcal</th><th></th></tr></thead><tbody>'
        + items.map(x=>`<tr><td>${escapeHtml(x.name)}</td><td>${x.mins}</td><td>${x.cals}</td><td><button data-id="${x.id}" class="btn ghost small removeEx">Remove</button></td></tr>`).join('')
        + '</tbody></table>' : '<div class="muted small">No exercises logged today</div>';
      exList.querySelectorAll('.removeEx').forEach(b=>{
        b.addEventListener('click', ()=> removeExercise(todayKey(), b.dataset.id));
      });

      // sidebar exercise list
      const dates = Object.keys(state.exercises).sort((a,b)=>b.localeCompare(a));
      exerciseList.innerHTML = dates.length ? dates.slice(0,5).map(d=>{
        const items = state.exercises[d];
        const sum = items.reduce((s,i)=>s+i.cals,0);
        return `<div style="margin-bottom:6px"><div style="display:flex;justify-content:space-between"><div style="font-weight:700">${formatDate(d)}</div><div class="muted small">${sum} kcal</div></div></div>`;
      }).join('') : '<div class="muted small">No exercise logs</div>';
    }

    function renderTotals() {
      const today = todayKey();
      const meals = (state.meals[today]||[]).reduce((s,i)=>s+i.cals,0);
      const ex = (state.exercises[today]||[]).reduce((s,i)=>s+i.cals,0);
      calSummary.textContent = `Calories: ${meals} in • ${ex} out`;
      totalToday.textContent = `${meals} kcal`;
      // week total (last 7 days)
      const now = new Date();
      let weekSum = 0;
      for(let i=0;i<7;i++){
        const d = new Date(now); d.setDate(now.getDate()-i);
        const k = d.toISOString().slice(0,10);
        weekSum += (state.meals[k]||[]).reduce((s,i)=>s+i.cals,0);
      }
      totalWeek.textContent = `${weekSum} kcal`;
    }

    // Profile & calculations
    function populateCalcFields() {
      const p = state.profile;
      inputWeight.value = p.weight || '';
      inputHeight.value = p.height || '';
      inputAge.value = p.age || '';
      inputGender.value = p.gender || 'male';
    }
    function performCalc() {
      const w = parseFloat(inputWeight.value);
      const h = parseFloat(inputHeight.value);
      const age = parseInt(inputAge.value);
      const g = inputGender.value;
      const bmi = calcBMI(w,h);
      if(bmi !== null){
        bmiVal.textContent = `${bmi} BMI`;
        bmiCat.textContent = bmiCategory(bmi);
      } else {
        bmiVal.textContent = 'BMI —';
        bmiCat.textContent = '—';
      }
      const bmr = calcBMR(g,w,h,age);
      bmrVal.textContent = bmr ? `${bmr} kcal` : '— kcal';
      const tdee = bmr ? Math.round(bmr * parseFloat(activity.value)) : null;
      tdeeVal.textContent = tdee ? `${tdee} kcal` : '— kcal';
      const goal = goalSelect.value;
      let target = tdee;
      if(tdee){
        if(goal.startsWith('lose')) {
          const amt = goal.split('-')[1] || '0';
          // approximate kcal deficit: 0.5kg/week ~ 500 kcal/day
          if(goal.includes('0.25')) target = tdee - 250;
          if(goal.includes('0.5')) target = tdee - 500;
        } else if(goal.startsWith('gain')) {
          if(goal.includes('0.25')) target = tdee + 250;
        }
      }
      targetVal.textContent = target ? `${target} kcal` : '— kcal';
      return {bmi, bmr, tdee, target};
    }

    // Save profile from dashboard quick save
    saveProfileBtn.addEventListener('click', ()=> {
      const p = state.profile;
      p.weight = parseFloat(inputWeight.value) || p.weight;
      p.height = parseFloat(inputHeight.value) || p.height;
      p.age = parseInt(inputAge.value) || p.age;
      p.gender = inputGender.value || p.gender;
      if(p.weight) state.weights[todayKey()] = p.weight;
      save();
    });

    saveBtn.addEventListener('click', ()=> {
      const p = state.profile;
      p.name = fullName.value || p.name;
      p.targetWeight = parseFloat(targetWeight.value) || p.targetWeight;
      p.notes = notes.value || p.notes;
      save();
    });

    clearBtn.addEventListener('click', ()=> {
      if(confirm('Clear profile fields (this will not delete saved data)?')) {
        fullName.value=''; targetWeight.value=''; notes.value='';
      }
    });

    calcBtn.addEventListener('click', ()=> {
      const out = performCalc();
      // update profile basic fields if user wants quick sync
      const p = state.profile;
      p.weight = parseFloat(inputWeight.value) || p.weight;
      p.height = parseFloat(inputHeight.value) || p.height;
      p.age = parseInt(inputAge.value) || p.age;
      p.gender = inputGender.value || p.gender;
      save();
    });

    // Add meal/exercise handlers
    addMealBtn.addEventListener('click', ()=> {
      const name = mealName.value.trim(); const c = parseInt(mealCals.value) || 0;
      if(!name){ alert('Add a meal name'); return; }
      addMeal(todayKey(), name, c);
      mealName.value=''; mealCals.value='';
    });
    addExBtn.addEventListener('click', ()=> {
      const name = exName.value.trim(); const mins = parseInt(exMin.value)||0; const c = parseInt(exCals.value)||0;
      if(!name){ alert('Add exercise name'); return; }
      addExercise(todayKey(), name, mins, c);
      exName.value=''; exMin.value=''; exCals.value='';
    });

    quickAddMeal.addEventListener('click', ()=> {
      sections.forEach(s=>s.style.display = s.id==='dashboard' ? '' : 'none');
      tabs.forEach(b=> b.dataset.tab==='dashboard' ? b.classList.add('active') : b.classList.remove('active'));
      mealName.focus();
    });
    quickAddExercise.addEventListener('click', ()=> {
      sections.forEach(s=>s.style.display = s.id==='dashboard' ? '' : 'none');
      tabs.forEach(b=> b.dataset.tab==='dashboard' ? b.classList.add('active') : b.classList.remove('active'));
      exName.focus();
    });

    // Weight chart drawing (simple)
    function drawWeightChart() {
      const canvas = weightChart;
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const dates = Object.keys(state.weights).sort();
      const w = canvas.width = canvas.clientWidth * devicePixelRatio;
      const h = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      if(dates.length===0) {
        ctx.fillStyle = 'rgba(255,255,255,0.06)';
        ctx.font = `${12*devicePixelRatio}px sans-serif`;
        ctx.fillText('No weight history', 10*devicePixelRatio, 20*devicePixelRatio);
        return;
      }
      const vals = dates.map(d=>state.weights[d]);
      const min = Math.min(...vals); const max = Math.max(...vals);
      const padding = 24*devicePixelRatio;
      const plotW = w - padding*2; const plotH = h - padding*2;
      ctx.strokeStyle = 'rgba(34,197,94,0.9)';
      ctx.lineWidth = 2*devicePixelRatio;
      ctx.beginPath();
      vals.forEach((v,i)=>{
        const x = padding + (i/(vals.length-1 || 1)) * plotW;
        const y = padding + (1 - (v - min)/(max-min || 1)) * plotH;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();
      // points
      ctx.fillStyle = 'rgba(34,197,94,1)';
      vals.forEach((v,i)=>{
        const x = padding + (i/(vals.length-1 || 1)) * plotW;
        const y = padding + (1 - (v - min)/(max-min || 1)) * plotH;
        ctx.beginPath(); ctx.arc(x,y,3*devicePixelRatio,0,Math.PI*2); ctx.fill();
      });
    }

    // Cal chart (last 7 days)
    function drawCalChart() {
      const canvas = calChart;
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth * devicePixelRatio;
      const h = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.clearRect(0,0,w,h);
      const now = new Date();
      const labels = [];
      const data = [];
      for(let i=6;i>=0;i--){
        const d = new Date(now); d.setDate(now.getDate()-i);
        const k = d.toISOString().slice(0,10);
        labels.push(d.toLocaleDateString());
        data.push((state.meals[k]||[]).reduce((s,i)=>s+i.cals,0));
      }
      const max = Math.max(...data, 200);
      const padding = 24*devicePixelRatio;
      const barW = (w - padding*2) / data.length * 0.7;
      data.forEach((val,i)=>{
        const x = padding + i * ((w-padding*2)/data.length) + ((w-padding*2)/data.length - barW)/2;
        const barH = (val/max) * (h - padding*2);
        ctx.fillStyle = 'rgba(6,182,212,0.9)';
        ctx.fillRect(x, h-padding-barH, barW, barH);
        ctx.fillStyle = 'rgba(255,255,255,0.8)';
        ctx.font = `${10*devicePixelRatio}px sans-serif`;
        ctx.fillText(val, x, h-padding-barH - 6*devicePixelRatio);
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.font = `${10*devicePixelRatio}px sans-serif`;
        ctx.fillText(labels[i], x, h - 6*devicePixelRatio);
      });
    }

    function renderRecentLogs() {
      const keys = Object.keys(state.meals).concat(Object.keys(state.exercises)).filter(Boolean);
      const uniq = Array.from(new Set(keys)).sort((a,b)=>b.localeCompare(a));
      recentLogs.innerHTML = uniq.slice(0,7).map(d=>{
        const m = (state.meals[d]||[]).reduce((s,i)=>s+i.cals,0);
        const e = (state.exercises[d]||[]).reduce((s,i)=>s+i.cals,0);
        return `<div style="display:flex;justify-content:space-between"><div>${formatDate(d)}</div><div class="muted small">${m} in • ${e} out</div></div>`;
      }).join('');
    }

    function renderAll() {
      renderMini();
      populateCalcFields();
      performCalc();
      renderMealsList();
      renderExercises();
      renderTotals();
      drawWeightChart();
      drawCalChart();
      renderRecentLogs();

      // stats
      statWeight.textContent = state.profile.weight ? `${state.profile.weight} kg` : '—';
      statBmi.textContent = state.profile.weight && state.profile.height ? (calcBMI(state.profile.weight, state.profile.height) || '—') : '—';
      statTarget.textContent = state.profile.targetWeight ? `${state.profile.targetWeight} kg` : '—';
      todayDate.textContent = new Date().toLocaleDateString();
      // recent logs for progress
    }

    // small helpers
    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    // Export / import
    exportBtn.addEventListener('click', ()=> {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'health-manager-backup.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        try {
          const obj = JSON.parse(reader.result);
          if(confirm('Importing will overwrite current data. Continue?')) {
            state = obj; save();
            alert('Import successful');
          }
        } catch(err){ alert('Invalid file'); }
      };
      reader.readAsText(f);
    });

    // Reset
    resetBtn.addEventListener('click', ()=> {
      if(confirm('Clear all app data? This cannot be undone.')) {
        localStorage.removeItem(storageKey);
        state = {profile:{name:'User', age:30, weight:70, height:170, gender:'male', targetWeight:null, notes:''}, meals:{}, exercises:{}, weights:{}, createdAt:new Date().toISOString()};
        save();
      }
    });

    // Recent updates: add weight when saved daily
    // Add event: whenever a meal/exercise is added or profile weight changes we save weights entry
    // initial render
    renderAll();

    // bind dynamic events for elements added later are handled in render functions

    // small UX: store weight on blur in profile quick fields
    inputWeight.addEventListener('blur', ()=> {
      const w = parseFloat(inputWeight.value);
      if(w) {
        state.profile.weight = w;
        state.weights[todayKey()] = w;
        save();
      }
    });

    // Meal quick add from meals page
    $('#addQuickFood').addEventListener('click', ()=> {
      const n = $('#foodQuickName').value.trim(); const c = parseInt($('#foodQuickCals').value) || 0;
      if(!n){ alert('Add food name'); return; }
      addMeal(todayKey(), n, c);
      $('#foodQuickName').value=''; $('#foodQuickCals').value='';
      // switch to meals tab?
    });

    // Add exercise quick from meals page
    $('#addQuickFood').addEventListener('keydown', (e)=> {
      if(e.key === 'Enter') $('#addQuickFood').click();
    });

    // Responsive canvas redraw on resize
    let resizeTimeout;
    window.addEventListener('resize', ()=> {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(()=> { drawWeightChart(); drawCalChart(); }, 200);
    });

    // Make charts high-DPI friendly
    drawWeightChart(); drawCalChart();

    // On load show dashboard
    sections.forEach(s=> s.style.display = s.id==='dashboard' ? '' : 'none');

    // small accessibility: keyboard navigation for tabs
    document.addEventListener('keydown', (e)=>{
      if(e.altKey && e.key==='1'){ tabs[0].click(); }
    });

  </script>
</body>
</html>